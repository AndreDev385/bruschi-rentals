---
import { authClient } from "@/lib/auth0.server";
import { setSession } from "@/lib/auth";

// Handle Auth0 callback
const url = new URL(Astro.request.url);
const code = url.searchParams.get("code");
const _state = url.searchParams.get("state");

if (!code) {
  // Error handling
  return Astro.redirect("/login?error=missing_code");
}

try {
  // Exchange code for tokens
  const tokenSet = await authClient.oauth.authorizationCodeGrant({
    code,
    redirect_uri: `${import.meta.env.AUTH0_BASE_URL}/auth/callback`,
  });

  // Handle tokenSet response (may be wrapped)
  const tokens = tokenSet.data || tokenSet;

  // Decode id_token to get user info and roles
  const idTokenPayload = JSON.parse(
    Buffer.from(tokens.id_token.split(".")[1], "base64").toString(),
  );

  // Check if user has 'client' role
  const roles =
    idTokenPayload["https://mydomain.com/roles"] || idTokenPayload.roles || [];
  if (!roles.includes("client")) {
    return Astro.redirect("/login?error=unauthorized");
  }

  // Create session
  const session = {
    user: {
      id: idTokenPayload.sub,
      email: idTokenPayload.email,
      name: idTokenPayload.name,
      role: "client",
    },
    accessToken: tokens.access_token,
    refreshToken: tokens.refresh_token,
  };

  setSession(Astro, session);

  // Redirect to welcome page for first-time login experience
  return Astro.redirect("/welcome");
} catch (error) {
  console.error("Auth callback error:", error);
  return Astro.redirect("/login?error=auth_failed");
}
---
